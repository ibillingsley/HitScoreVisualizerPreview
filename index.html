<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="Color preview tool for Beat Saber HitScoreVisualizer mod">
  <title>HitScoreVisualizer Preview</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      font-family: sans-serif;
    }

    #scores {
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      flex-grow: 1;
      justify-content: center;
      align-items: center;
      background: black url(glass-desert-env.jpg) center;
      background-size: cover;
      color: white;
      font-weight: bold;
      font-size: 125%;
      text-align: center;
    }

    #data {
      display: flex;
      flex-direction: column;
      background: black;
      color: white;
    }

    #text {
      flex-grow: 1;
      width: 40vw;
      background: inherit;
      color: inherit;
    }

    #text.error {
      outline: solid thin red;
    }

    #color {
      position: fixed;
      width: 30px;
      height: 30px;
      padding: 0;
      background: transparent;
    }

    #color:not(.active) {
      display: none;
    }

  </style>
</head>
<body>
  <div id="scores"></div>
  <div id="data">
    <input id="file" type="file" accept=".json">
    <textarea id="text">{
  "majorVersion": 3,
  "minorVersion": 3,
  "patchVersion": 3,
  "displayMode": "format",
  "doIntermediateUpdates": true,
  "timeDependencyDecimalPrecision": 1,
  "timeDependencyDecimalOffset": 2,
  "judgments": [
    {
      "threshold": 115,
      "text": "%BFantastic%A%n%s",
      "color": [
        1.0,
        1.0,
        1.0,
        1.0
      ],
      "fade": false
    },
    {
      "threshold": 101,
      "text": "<size=80%>%BExcellent%A</size>%n%s",
      "color": [
        0.0,
        1.0,
        0.0,
        1.0
      ],
      "fade": false
    },
    {
      "threshold": 90,
      "text": "<size=80%>%BGreat%A</size>%n%s",
      "color": [
        1.0,
        0.980392158,
        0.0,
        1.0
      ],
      "fade": false
    },
    {
      "threshold": 80,
      "text": "<size=80%>%BGood%A</size>%n%s",
      "color": [
        1.0,
        0.6,
        0.0,
        1.0
      ],
      "fade": true
    },
    {
      "threshold": 60,
      "text": "<size=80%>%BDecent%A</size>%n%s",
      "color": [
        1.0,
        0.0,
        0.0,
        1.0
      ],
      "fade": true
    },
    {
      "threshold": 0,
      "text": "<size=80%>%BWay Off%A</size>%n%s",
      "color": [
        0.5,
        0.0,
        0.0,
        1.0
      ],
      "fade": true
    }
  ],
  "beforeCutAngleJudgments": [
    {
      "threshold": 70,
      "text": " + "
    },
    {
      "threshold": 0,
      "text": " "
    }
  ],
  "accuracyJudgments": [
    {
      "threshold": 15,
      "text": " + "
    },
    {
      "threshold": 0,
      "text": " "
    }
  ],
  "afterCutAngleJudgments": [
    {
      "threshold": 30,
      "text": " + "
    },
    {
      "threshold": 0,
      "text": " "
    }
  ]
}
</textarea>
  </div>
  <input id="color" type="color">
  <script>
    const container = document.getElementById('scores');
    const textInput = document.getElementById('text');
    const fileInput = document.getElementById('file');
    const colorInput = document.getElementById('color');
    const colorRegex = /"color"\s*:\s*\[\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*[\d.]+\s*\]/g;

    function render(json) {
      const displayMode = json.displayMode || 'default';
      container.innerHTML = '';
      for (const judgment of json.judgments) {
        judgment.threshold = judgment.threshold || 0;
        judgment.text = judgment.text || '';
        const score = document.createElement('p');
        switch (displayMode) {
          case 'format':
            score.innerHTML = format(judgment, json);
            break;
          case 'numeric':
            score.textContent = judgment.threshold;
            break;
          case 'textOnly':
            score.textContent = judgment.text;
            break;
          case 'scoreOnTop':
            score.appendChild(document.createElement('span')).textContent = judgment.threshold;
            score.appendChild(document.createElement('br'));
            score.appendChild(document.createElement('span')).textContent = judgment.text;
            break;
          default:
            score.appendChild(document.createElement('span')).textContent = judgment.text;
            score.appendChild(document.createElement('br'));
            score.appendChild(document.createElement('span')).textContent = judgment.threshold;
            break;
        }
        score.className = 'score';
        score.style.color = `rgb(${judgment.color.slice(0, 3).map(c => c * 255).join(',')})`;
        container.appendChild(score);
      }
    }

    function format(judgment, json) {
      let text = judgment.text;
      text = text.replaceAll(/<size=([^>]+)>/g, '<span style="font-size: $1">');
      text = text.replaceAll('</size>', '</span>');
      text = text.replaceAll(/<color=([^>]+)>/g, '<span style="color: $1">');
      text = text.replaceAll('</color>', '</span>');
      text = text.replaceAll('%b', 70);
      text = text.replaceAll('%c', 15);
      text = text.replaceAll('%a', 30);
      text = text.replaceAll('%t', (5 / 9 * 10 ** (json.timeDependencyDecimalOffset || 0)).toFixed(json.timeDependencyDecimalPrecision || 0));
      text = text.replaceAll('%B', json.beforeCutAngleJudgments?.[0]?.text || '');
      text = text.replaceAll('%C', json.accuracyJudgments?.[0]?.text || '');
      text = text.replaceAll('%A', json.afterCutAngleJudgments?.[0]?.text || '');
      text = text.replaceAll('%T', json.timeDependencyJudgments?.[0]?.text || '');
      text = text.replaceAll('%s', judgment.threshold);
      text = text.replaceAll('%n', '<br>');
      text = text.replaceAll('%%', '%');
      return text;
    }

    textInput.oninput = () => {
      textInput.classList.add('error');
      const json = JSON.parse(textInput.value);
      if (json && json.judgments) {
        render(json);
        textInput.classList.remove('error');
      }
    }
    textInput.oninput();

    // Color picker
    textInput.addEventListener('click', (e) => {
      const cursor = textInput.selectionDirection === 'forward' ? textInput.selectionEnd : textInput.selectionStart;
      const matches = textInput.value.matchAll(colorRegex);
      for (const match of matches) {
        if (cursor > match.index && cursor < match.index + match[0].length) {
          // Cursor in color block, show picker
          colorInput.value = '#' + [match[1], match[2], match[3]].map((value) => {
            value = Math.round(value * 255).toString(16);
            return value.length < 2 ? '0' + value : value;
          }).join('');
          colorInput.style.left = e.clientX + 50 + 'px';
          colorInput.style.top = e.clientY - 13 + 'px';
          colorInput.classList.add('active');
          colorInput.oninput = () => {
            // Replace color
            const hex = parseInt(colorInput.value.substring(1), 16);
            const r = (((hex >> 16) & 255) / 255).toFixed(3);
            const g = (((hex >> 8) & 255) / 255).toFixed(3);
            const b = ((hex & 255) / 255).toFixed(3);
            const split = match[0].split(',');
            split[0] = split[0].replace(/[\d.]+/, r);
            split[1] = split[1].replace(/[\d.]+/, g);
            split[2] = split[2].replace(/[\d.]+/, b);
            textInput.value = match.input.substring(0, match.index) + split.join(',') + match.input.substring(match.index + match[0].length);
            textInput.oninput();
          };
          return;
        }
      }
      hideColorPicker();
    });

    function hideColorPicker() {
      colorInput.classList.remove('active');
      colorInput.oninput = null;
    }

    textInput.addEventListener('input', hideColorPicker);

    // File input
    async function setFile(file) {
      const text = await file.text();
      textInput.value = text;
      textInput.oninput();
      hideColorPicker();
    }

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (file) setFile(file);
    };

    // Drag and drop
    container.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    document.body.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/json' && e.target !== fileInput) {
        e.preventDefault();
        setFile(file);
      }
    });
  </script>
</body>
</html>
